// FIRESTORE RULES
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Posts collection
    match /posts/{postId} {
      allow read: if true; // Public read
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;

      // Update rules
      allow update: if request.auth != null && (
        // Owner can update content fields
        (
          request.auth.uid == resource.data.userId &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'text',
            'content',
            'genre',
            'genreColor',
            'modulationType',
            'audioUrl',
            'mediaUrl',
            'waveform',
            'updatedAt',
            'isEdited'
          ])
        )
        ||
        // Non-owner can only update report fields
        (
          request.auth.uid != resource.data.userId &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'reported',
            'reports',
            'updatedAt'
          ])
        )
      );

      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;

      // Likes subcollection
      match /likes/{userId} {
        allow read: if true;
        allow create: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if true;
        allow create: if request.auth != null;
        allow update: if request.auth != null && request.auth.uid == resource.data.userId;
        allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
      }
    }

    // Users collection
    match /users/{uid} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == uid;
      
      // Saved posts subcollection - private to user
      match /savedPosts/{postId} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // Usernames collection (server-only writes)
    match /usernames/{usernameLower} {
      allow read: if true;
      allow write: if false;
    }
  }
}
